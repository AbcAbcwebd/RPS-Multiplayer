<!DOCTYPE html>
<html lang="en-us">

<head>
	<meta charset="UTF-8">
	<title>Rock Paper Scissors - Online Multiplayer</title>
	<script src="https://code.jquery.com/jquery-3.1.1.js"></script>
	<script src="assets/javascript/app.js"></script>
	<link rel="stylesheet" type="text/css" href="assets/css/reset.css">
	<link rel="stylesheet" type="text/css" href="assets/css/style.css">
</head>
<body>
	<script src="https://www.gstatic.com/firebasejs/4.1.3/firebase.js"></script>
	<script>
	  // Initialize Firebase
	  var config = {
	    apiKey: "AIzaSyAL9qWQ1BQ1YJzIlDCGKG05Nu_-fZcaLYU",
	    authDomain: "obe-rock-paper-scissors.firebaseapp.com",
	    databaseURL: "https://obe-rock-paper-scissors.firebaseio.com",
	    projectId: "obe-rock-paper-scissors",
	    storageBucket: "obe-rock-paper-scissors.appspot.com",
	    messagingSenderId: "291973353413"
	  };
	  firebase.initializeApp(config);
	</script>
	<div id="account-display"></div>
	<div id="main-stage"></div>
	<div id="message-console"></div>

	<script>
		getUserName();

		var database = firebase.database();
		var currentUser;
		var activeUserPath;
		var currentUserCount = 0;
		var activeUserList = [];

		// This keeps track of whether or not we're currently displaying the active user list. 
		var displayUserList = false;

		function addActiveUserData(newUser) {
		  firebase.database().ref('activeUsers/' + newUser).set({
		    name: newUser
		  });
		  currentUser = newUser;
		  activeUserPath = firebase.database().ref('activeUsers/' + currentUser)
		  activeUserPath.onDisconnect().remove();
		};

		// This sets things up for the user to pick a challenger
		function generateActiveUsersList(){
			$('#active-user-display').remove();
			var activeUsersDisplay = $('<div>').attr("id", "active-user-display");
			var challengeInstructions = $('<p>').text("Who would you like to challenge?");
			activeUsersDisplay.append(challengeInstructions);
			// ATTN: This needs to be fixed. 
			if (activeUserList.length === 0){
				var noChallengersWarning = $('<p>').text("Sorry, no one's here for you to challenge!");
				activeUsersDisplay.append(noChallengersWarning);
			};

			for (var x = 0; x < activeUserList.length; x++){
				// Adds all active users to list of competitors, except this windows current user.
				if (activeUserList[x] != currentUser){
					var newP = $('<p>').text(activeUserList[x]);
					newP.attr("class", "player-list-item");
					activeUsersDisplay.append(newP);
				};
			}
			$('#main-stage').append(activeUsersDisplay);
		};

		function initChallenge(target){
			firebase.database().ref('activeUChallenges/' + currentUser + '-' + target).set({
				challenger: currentUser,
				target: target,
				ChallengeStatus: "is_open"
			});
		};

		// Click functionality goes here
		$( document ).ready(function() {
			$("#set-name-button").on("click", function() {
				event.preventDefault();
				var userInput = $('#name-input').val();
				// Validates user input to make sure it's not blank and not a duplicate username.
				if (userInput.length === 0) {
					$('#error-display').text("Please enter a valid screen name.");
				} else if (activeUserList.indexOf(userInput) > -1){
					$('#error-display').text("Sorry, that name's already taken.");
				} else {
					addActiveUserData(userInput);
					moveOffPage("account-display");
					generateActiveUsersList();
					displayUserList = true;
				};
				
			});

			$("body").on("click", "p.player-list-item", function(){
				var enemyTarget = $(this)[0].innerText;
				initChallenge(enemyTarget);
			});
/*
			$("body").on("click", "p.player-list-item", function(){
				var enemyTarget = $(this)[0].innerText;
				initChallenge(enemyTarget);
			});*/
		});

		Object.size = function(obj) {
		    var size = 0, key;
		    for (key in obj) {
		        if (obj.hasOwnProperty(key)) size++;
		    }
		    return size;
		};

		// This interacts with the database and maintains a list of active users.
		database.ref('activeUsers/').on("value", function(snapshot){
			var activeUsersObj = snapshot.val();
			currentUserCount = Object.size(activeUsersObj);
			activeUserList = [];
			for (var key in activeUsersObj) {
			  if (activeUsersObj.hasOwnProperty(key)) {
			    activeUserList.push(key);
			  }
			}

			// If the current user list is currently being displayed, it will be updated.
			if (displayUserList){
				generateActiveUsersList();
			}
		}, function(error){
			console.log(error);
		});

		// This keeps tabs on open challenges
		database.ref('activeUChallenges/').on("value", function(snapshot){
			var activeChallengesObj = snapshot.val();
			for (var key in activeChallengesObj) {
			    if (activeChallengesObj.hasOwnProperty(key)) {
				    var localChallenger = key.split("-")[0];
				    var localTarget = key.split("-")[1];
				    var localPath = activeChallengesObj[localChallenger + "-" + localTarget];
				    var localStatus = localPath.ChallengeStatus;

				    // This removes open challengs if one or both of the users has left the site.
				    // Next the function checks to see if the current user is being challenged. 
				    // The next part checks for responses to open challenges from current user.
				    if (activeUserList.indexOf(localChallenger) < 0 || activeUserList.indexOf(localTarget) < 0){
				    	database.ref('activeUChallenges/' + key).remove();
				    } else if (localTarget === currentUser && localStatus === "is_open"){
				    	console.log("Player being challenged")
				    	// Current user is being challenged! 
				    	var challengeMessage = $('<p>').attr("class", "message game-message");
				    	challengeMessage.text("You've been challenged by " + localChallenger + "!");
				    	var acceptButton = $('<button>').attr('class', 'chat-button accept-button');
				    	acceptButton.attr('data-attribute', key);
				    	acceptButton.text("Accept");
				    	var declineButton = $('<button>').attr('class', 'chat-button decline-button');
				    	declineButton.attr('data-attribute', key);
				    	declineButton.text("Decline");
				    	challengeMessage.append(acceptButton);
				    	challengeMessage.append(declineButton);
				    	$('#message-console').append(challengeMessage);

				    	// This updates the status of the challenge so it is not re-posted.
						firebase.database().ref('activeUChallenges/' + key).update({
							ChallengeStatus: "recieved"
						});
				    } else if (localChallenger === currentUser){
				//    	console.log(key.ChallengeStatus);
				    };
			    };
			};
		}, function(error){
			console.log(error);
		});

	</script>
</body>
</html>