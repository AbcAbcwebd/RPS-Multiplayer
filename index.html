<!DOCTYPE html>
<html lang="en-us">

<head>
	<meta charset="UTF-8">
	<title>Rock Paper Scissors - Online Multiplayer</title>
	<script src="https://code.jquery.com/jquery-3.1.1.js"></script>
	<script src="assets/javascript/app.js"></script>
	<link rel="stylesheet" type="text/css" href="assets/css/reset.css">
	<link rel="stylesheet" type="text/css" href="assets/css/style.css">
</head>
<body>
	<script src="https://www.gstatic.com/firebasejs/4.1.3/firebase.js"></script>
	<script>
	  // Initialize Firebase
	  var config = {
	    apiKey: "AIzaSyAL9qWQ1BQ1YJzIlDCGKG05Nu_-fZcaLYU",
	    authDomain: "obe-rock-paper-scissors.firebaseapp.com",
	    databaseURL: "https://obe-rock-paper-scissors.firebaseio.com",
	    projectId: "obe-rock-paper-scissors",
	    storageBucket: "obe-rock-paper-scissors.appspot.com",
	    messagingSenderId: "291973353413"
	  };
	  firebase.initializeApp(config);
	</script>
	<div id="account-display"></div>
	<div id="main-stage"></div>
	<div id="message-console"></div>

	<script>
		getUserName();

		var database = firebase.database();
		var currentUser;
		var activeUserPath;
		var currentUserCount = 0;
		var activeUserList = [];
		var gameChallenger;
		var gamePath;

		// This keeps track of whether or not we're currently displaying the active user list. 
		var displayUserList = false;

		function addActiveUserData(newUser) {
		  firebase.database().ref('activeUsers/' + newUser).set({
		    name: newUser
		  });
		  currentUser = newUser;
		  activeUserPath = firebase.database().ref('activeUsers/' + currentUser)
		  activeUserPath.onDisconnect().remove();
		};

		// This sets things up for the user to pick a challenger
		function generateActiveUsersList(){
			$('#active-user-display').remove();
			var activeUsersDisplay = $('<div>').attr("id", "active-user-display");
			var challengeInstructions = $('<p>').text("Who would you like to challenge?");
			activeUsersDisplay.append(challengeInstructions);
			// ATTN: This needs to be fixed. 
			if (activeUserList.length === 0){
				var noChallengersWarning = $('<p>').text("Sorry, no one's here for you to challenge!");
				activeUsersDisplay.append(noChallengersWarning);
			};

			for (var x = 0; x < activeUserList.length; x++){
				// Adds all active users to list of competitors, except this windows current user.
				if (activeUserList[x] != currentUser){
					var newP = $('<p>').text(activeUserList[x]);
					newP.attr("class", "player-list-item");
					activeUsersDisplay.append(newP);
				};
			}
			$('#main-stage').append(activeUsersDisplay);
		};

		function initChallenge(target){
			firebase.database().ref('activeUChallenges/' + currentUser + '-' + target).set({
				challenger: currentUser,
				target: target,
				ChallengeStatus: "is_open"
			});
		};

		// This is for displaying messages to the messaging console prior to the start of the game. 
		// Unlike after the start of the game, these messages are not saved to the database. 
		function printMessage(from, message){
			var localMessage = $('<p>').html("<strong>" + from + ": </strong>" + message);
			localMessage.attr('class', 'message');
			$('#message-console').append(localMessage);
		};

		function gamePlay(){
			database.ref('activeGames/' + gamePath).on("value", function(snapshot){
				var gameObj = snapshot.val();
				console.log(gameObj);

				// Adds names to player displays
				$('#play1-title').text(gameObj.playerOne);
				$('#play2-title').text(gameObj.playerTwo);
			}, function(error){
				console.log(error);
			});
		};

		function startGame(){
			// Clears out the previous parts of the game.
			$('#main-stage').remove();
			$('#message-console').remove();

			// This removes the player from the list of players looking for competitors. 
			activeUserPath.remove();

			// This generates elements for the new game play.
			// Player display
			var player1Display = $('<div>').attr('id', 'player1-display');
			var player1Title = $('<h2>').attr('id', 'play1-title');
			var player1StatusDisplay = $('<div>').attr('id', 'player1-status-display');
			var player1WinsDisplay = $('<p>').html("Total wins: <span id='player1-wins-display'>0</span>");
			player1Display.append(player1Title);
			player1Display.append(player1StatusDisplay);
			player1Display.append(player1WinsDisplay);

			// Generates rounds lett message
			var roundsLeftDisplay = $('h3').attr('id', 'rounds-left-display');
			roundsLeftDisplay.html("Rounds remaining: <span id='rounds-left-display'>10</span>");

			// Player display
			var player2Display = $('<div>').attr('id', 'player2-display');
			var player2Title = $('<h2>').attr('id', 'play2-title');
			var player2StatusDisplay = $('<div>').attr('id', 'player2-status-display');
			var player2WinsDisplay = $('<p>').html("Total wins: <span id='player2-wins-display'>0</span>");
			player2Display.append(player2Title);
			player2Display.append(player2StatusDisplay);
			player2Display.append(player2WinsDisplay);

			var gameChatWindow = $('div').attr('id', 'game-chat-window');

			// Adds it all to the page
			$('body').append(player1Display);
			$('body').append(roundsLeftDisplay);
			$('body').append(player2Display);
			$('body').append(gameChatWindow);

			// The function for actual game play is then called. 
			gamePlay();
		};

		// Click functionality goes here
		$( document ).ready(function() {
			$("#set-name-button").on("click", function() {
				event.preventDefault();
				var userInput = $('#name-input').val();
				// Validates user input to make sure it's not blank and not a duplicate username.
				if (userInput.length === 0) {
					$('#error-display').text("Please enter a valid screen name.");
				} else if (activeUserList.indexOf(userInput) > -1){
					$('#error-display').text("Sorry, that name's already taken.");
				} else {
					addActiveUserData(userInput);
					moveOffPage("account-display");
					generateActiveUsersList();
					displayUserList = true;
				};
				
			});

			$("body").on("click", "p.player-list-item", function(){
				var enemyTarget = $(this)[0].innerText;
				initChallenge(enemyTarget);
			});

		});

		Object.size = function(obj) {
		    var size = 0, key;
		    for (key in obj) {
		        if (obj.hasOwnProperty(key)) size++;
		    }
		    return size;
		};

		// This interacts with the database and maintains a list of active users.
		database.ref('activeUsers/').on("value", function(snapshot){
			var activeUsersObj = snapshot.val();
			currentUserCount = Object.size(activeUsersObj);
			activeUserList = [];
			for (var key in activeUsersObj) {
			  if (activeUsersObj.hasOwnProperty(key)) {
			    activeUserList.push(key);
			  }
			}

			// If the current user list is currently being displayed, it will be updated.
			if (displayUserList){
				generateActiveUsersList();
			}
		}, function(error){
			console.log(error);
		});

		// This keeps tabs on open challenges
		database.ref('activeUChallenges/').on("value", function(snapshot){
			var activeChallengesObj = snapshot.val();
			for (var key in activeChallengesObj) {
			    if (activeChallengesObj.hasOwnProperty(key)) {
				    var localChallenger = key.split("-")[0];
				    var localTarget = key.split("-")[1];
				    var localPath = activeChallengesObj[localChallenger + "-" + localTarget];
				    var localStatus = localPath.ChallengeStatus;

				    // This removes open challengs if one or both of the users has left the site.
				    // Next the function checks to see if the current user is being challenged. 
				    // The next part checks for responses to open challenges from current user.
				    if (activeUserList.indexOf(localChallenger) < 0 || activeUserList.indexOf(localTarget) < 0){
				    	database.ref('activeUChallenges/' + key).remove();
				    } else if (localTarget === currentUser && localStatus === "is_open"){
				    	// Current user is being challenged! 
				    	var challengeMessage = $('<p>').attr("class", "message game-message");
				    	challengeMessage.text("You've been challenged by " + localChallenger + "!");
				    	var acceptButton = $('<button>').attr('class', 'chat-button accept-button');
				    	acceptButton.attr('value', localChallenger);
				    	acceptButton.text("Accept");
				    	var declineButton = $('<button>').attr('class', 'chat-button decline-button');
				    	declineButton.attr('value', localChallenger);
				    	declineButton.text("Decline");
				    	challengeMessage.append(acceptButton);
				    	challengeMessage.append(declineButton);
				    	$('#message-console').append(challengeMessage);

				    	// This is what happens when a player accepts a challenge.
						$("body").on("click", "button.accept-button", function(){
							gameChallenger = this.value;

							// The database is updated
							firebase.database().ref('activeUChallenges/' + key).update({
								ChallengeStatus: "accepted"
							});

							// This sets the key that will be used to access game play info.
							gamePath = currentUser + "-" + gameChallenger;

							// This sets up the object that will manage game play info.
							firebase.database().ref('activeGames/' + gamePath).set({
								playerOne: currentUser,
								playerTwo: gameChallenger,
								playerOneMove: "waiting",
								playerTwoMove: "waiting",
								playerOnePoints: 0,
								playerTwoPoints: 0,
								roundsRemaining: 10
							});

							startGame();
						});

						// This is what happens when a player declines a challenge.
						$("body").on("click", "button.decline-button", function(){
							// The database is updated
							firebase.database().ref('activeUChallenges/' + key).update({
								ChallengeStatus: "declined"
							});
							printMessage("Game", "You have declined the challenge.");
						});

				    	// This updates the status of the challenge so it is not re-posted.
						firebase.database().ref('activeUChallenges/' + key).update({
							ChallengeStatus: "recieved"
						});
				    } else if (localChallenger === currentUser){
						if (localStatus === "accepted"){
							printMessage("Game", localTarget + " has accepted your challenge!");
							gameChallenger = localTarget;

							// This sets the key that will be used to access game play info.
							gamePath = gameChallenger + "-" + currentUser;

							setTimeout(function() { 
								startGame();
							}, 2000);
						} else if (localStatus === "declined"){
							printMessage("Game", localTarget + " has declined your challenge.");

							firebase.database().ref('activeUChallenges/' + key).update({
								ChallengeStatus: "ended"
							});
						};  	
				    };
			    };
			};
		}, function(error){
			console.log(error);
		});

	</script>
</body>
</html>