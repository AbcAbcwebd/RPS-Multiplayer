<!DOCTYPE html>
<html lang="en-us">

<head>
	<meta charset="UTF-8">
	<title>Rock Paper Scissors - Online Multiplayer</title>
	<script src="https://code.jquery.com/jquery-3.1.1.js"></script>
	<script src="assets/javascript/app.js"></script>
	<link rel="stylesheet" type="text/css" href="assets/css/reset.css">
	<link rel="stylesheet" type="text/css" href="assets/css/style.css">
</head>
<body>
	<script src="https://www.gstatic.com/firebasejs/4.1.3/firebase.js"></script>
	<script>
	  // Initialize Firebase
	  var config = {
	    apiKey: "AIzaSyAL9qWQ1BQ1YJzIlDCGKG05Nu_-fZcaLYU",
	    authDomain: "obe-rock-paper-scissors.firebaseapp.com",
	    databaseURL: "https://obe-rock-paper-scissors.firebaseio.com",
	    projectId: "obe-rock-paper-scissors",
	    storageBucket: "obe-rock-paper-scissors.appspot.com",
	    messagingSenderId: "291973353413"
	  };
	  firebase.initializeApp(config);
	</script>
	<div id="account-display"></div>

	<script>
		getUserName();

		var database = firebase.database();
		var currentUser;
		var activeUserPath;
		var currentUserCount = 0;
		var activeUserList = [];

		// This keeps track of whether or not we're currently displaying the active user list. 
		var displayUserList = false;

		function addActiveUserData(newUser) {
		  firebase.database().ref('activeUsers/' + newUser).set({
		    name: newUser
		  });
		  currentUser = newUser;
		  activeUserPath = firebase.database().ref('activeUsers/' + currentUser)
		  activeUserPath.onDisconnect().remove();
		};

		function generateActiveUsersList(){
			var activeUsersDisplay = $('<div>').attr("id", "active-user-display");
			for (var x = 0; x < activeUserList.length; x++){
				var newP = $('<p>').text(activeUserList[x]);
				newP.attr("class", "player-list-item");
				activeUsersDisplay.append(newP);
			}
			$('body').append(activeUsersDisplay);
		};

		// Click functionality goes here
		$( document ).ready(function() {
			$("#set-name-button").on("click", function() {
				event.preventDefault();
				var userInput = $('#name-input').val();
				// Validates user input to make sure it's not blank and not a duplicate username.
				if (userInput.length === 0) {
					$('#error-display').text("Please enter a valid screen name.");
				} else if (activeUserList.indexOf(userInput) > -1){
					$('#error-display').text("Sorry, that name's already taken.");
				} else {
					addActiveUserData(userInput);
					moveOffPage("account-display");
					generateActiveUsersList();
					displayUserList = true;
				};
				
			});
		});

		Object.size = function(obj) {
		    var size = 0, key;
		    for (key in obj) {
		        if (obj.hasOwnProperty(key)) size++;
		    }
		    return size;
		};

		database.ref('activeUsers/').on("value", function(snapshot){
			var activeUsersObj = snapshot.val();
			currentUserCount = Object.size(activeUsersObj);
			activeUserList = [];
			for (var key in activeUsersObj) {
			  if (activeUsersObj.hasOwnProperty(key)) {
			    activeUserList.push(key);
			  }
			}

			// If the current user list is currently being displayed, it will be updated.
			if (displayUserList){
				generateActiveUsersList();
			}
		}, function(error){
			console.log(error);
		});

	</script>
</body>
</html>