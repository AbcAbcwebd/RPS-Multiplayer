<!DOCTYPE html>
<html lang="en-us">

<head>
	<meta charset="UTF-8">
	<title>Rock Paper Scissors - Online Multiplayer</title>
	<script src="https://code.jquery.com/jquery-3.1.1.js"></script>
	<script src="assets/javascript/app.js"></script>
	<link rel="stylesheet" type="text/css" href="assets/css/reset.css">
	<link rel="stylesheet" type="text/css" href="assets/css/style.css">
</head>
<body>
	<script src="https://www.gstatic.com/firebasejs/4.1.3/firebase.js"></script>
	<script>
	  // Initialize Firebase
	  var config = {
	    apiKey: "AIzaSyAL9qWQ1BQ1YJzIlDCGKG05Nu_-fZcaLYU",
	    authDomain: "obe-rock-paper-scissors.firebaseapp.com",
	    databaseURL: "https://obe-rock-paper-scissors.firebaseio.com",
	    projectId: "obe-rock-paper-scissors",
	    storageBucket: "obe-rock-paper-scissors.appspot.com",
	    messagingSenderId: "291973353413"
	  };
	  firebase.initializeApp(config);
	</script>
	<div id="account-display"></div>
	<div id="main-stage"></div>
	<div id="message-console"></div>

	<script>
		getUserName();

		var database = firebase.database();
		var currentUser;
		var activeUserPath;
		var currentUserCount = 0;
		var activeUserList = [];
		var gameChallenger;
		var gamePath;
		var localPlayer;
		var localMove = "none";
		var gameObj;
//		var inGamePlay = [];

		// These variables are used for per round game logic
		var userOneMove;
		var userTwoMove;

		// This keeps track of whether or not we're currently displaying the active user list. 
		var displayUserList = false;

		function addActiveUserData(newUser) {
			console.log("Adding active user")
		  firebase.database().ref('activeUsers/' + newUser).set({
		    name: newUser
		  });
		  currentUser = newUser;
		  activeUserPath = firebase.database().ref('activeUsers/' + currentUser)
		  activeUserPath.onDisconnect().remove();
		};

		// This sets things up for the user to pick a challenger
		function generateActiveUsersList(){
			console.log("Generating active user list")
			$('#active-user-display').remove();
			var activeUsersDisplay = $('<div>').attr("id", "active-user-display");
			var challengeInstructions = $('<p>').text("Who would you like to challenge?");
			activeUsersDisplay.append(challengeInstructions);
			// ATTN: This needs to be fixed. 
			if (activeUserList.length === 0){
				var noChallengersWarning = $('<p>').text("Sorry, no one's here for you to challenge!");
				activeUsersDisplay.append(noChallengersWarning);
			};

			for (var x = 0; x < activeUserList.length; x++){
				// Adds all active users to list of competitors, except this windows current user.
				if (activeUserList[x] != currentUser){
					var newP = $('<p>').text(activeUserList[x]);
					newP.attr("class", "player-list-item");
					activeUsersDisplay.append(newP);
				};
			}
			$('#main-stage').append(activeUsersDisplay);
		};

		function initChallenge(target){
			console.log("Challenge initiated")
			firebase.database().ref('activeUChallenges/' + currentUser + '-' + target).set({
				challenger: currentUser,
				target: target,
				ChallengeStatus: "is_open"
			});
		};

		// This is for displaying messages to the messaging console prior to the start of the game. 
		// Unlike after the start of the game, these messages are not saved to the database. 
		function printMessage(from, message){
			console.log("Printing message")
			var localMessage = $('<p>').html("<strong>" + from + ": </strong>" + message);
			localMessage.attr('class', 'message');
			$('#message-console').append(localMessage);
		};

		// This function detemines who won any particular round
		function comparePlay(){
			console.log("Comparing play")

			// For reference
			database.ref('activeGames').on("value", function(snapshot){
				gameObjT = snapshot.val();
				console.log(gameObjT);});

			if ((userOneMove === "Rock" && userTwoMove === "Scissors") || (userOneMove === "Paper" && userTwoMove === "Rock") || (userOneMove === "Scissors" && userTwoMove === "Paper")){
				// User one wins
				return "One wins";
			} else if ((userOneMove === "Rock" && userTwoMove === "Paper") || (userOneMove === "Paper" && userTwoMove === "Scissors") || (userOneMove === "Scissors" && userTwoMove === "Rock")){
				// User two wins
				return "Two wins";
			} else {
				// It's a tie
				return "Tie";
			};
		};

		// This function represents the meat of game play. It is the part of the app that monitors the game play JSON object for changes and calls additional functions as necesary. 
		// This function should perhaps be broken up into smaller functions. 
		// It has gotten big because much of the code within it needs access to the database object that is uses.
		function gamePlay(){
			console.log("Game play running")
		
			database.ref('activeGames').on("value", function(snapshot){
				console.log("Active games change detected")

				gameObj = snapshot.val()[gamePath];
				console.log(snapshot);
				console.log(gameObj);

				// Variables for this function 
				var playerOneLocalPoints = gameObj.playerOnePoints;
				var playerTwoLocalPoints = gameObj.playerTwoPoints;
				var localRoundsRemaining = gameObj.roundsRemaining;
				
				// Adds names to player displays
				$('#play1-title').text(gameObj.playerOne);
				$('#play2-title').text(gameObj.playerTwo);

				// Checks to see if current user is player 1 or 2.
				console.log("Current user: " + currentUser);
				console.log("Player one: " + gameObj.playerOne)
				if (currentUser === gameObj.playerOne){
					localPlayer = "One";
				} else if (currentUser === gameObj.playerTwo){
					localPlayer = "Two";
				};
				console.log("localPlayer: " + localPlayer);

				// Defines the gameplay HTML elements
				var itemChoices = $('<div>');
				var rock = $('<p>').text("Rock").attr('class', 'game-choice').attr('type', 'Rock');
				var paper = $('<p>').text("Paper").attr('class', 'game-choice').attr('type', 'Paper');
				var scissors = $('<p>').text("Scissors").attr('class', 'game-choice').attr('type', 'Scissors');
				itemChoices.append(rock, paper, scissors);

				var otherPlayerWaiting = $('<p>').text("?").attr('class', 'wait-mark');

				
				console.log("Starting game logic")
				console.log("localPlayer: " + localPlayer);
				// Keeps track of whose turn it is and monitors game status.
				if (localPlayer === "One" && gameObj.playerOneMove === "waiting"){
					console.log("First running")
					// Player one should be given play choices.
					$('#player1-status-display').html(itemChoices);
					$('#player2-status-display').html(otherPlayerWaiting);
				} else if (localPlayer === "Two" && gameObj.playerTwoMove === "waiting"){
					console.log("Second running")
					// Player two should be given play choices. 
					$('#player2-status-display').html(itemChoices);
					$('#player1-status-display').html(otherPlayerWaiting);
				} else if (localPlayer === "One" && gameObj.playerOneMove != "waiting" && gameObj.playerTwoMove === "waiting") {
					console.log("Third running")

		/*			// For reference
					database.ref('activeGames').on("value", function(snapshot){
						gameObjT = snapshot.val();
						console.log(gameObjT);}); */


					// Waiting on player two.
					$('#player1-status-display').html("<p>Waiting on " + gameObj.playerTwo + "</p>");
					$('#player2-status-display').html(otherPlayerWaiting);
				} else if (localPlayer === "Two" && gameObj.playerTwoMove != "waiting" && gameObj.playerOneMove === "waiting"){
					console.log("Fourth runnning")
					// Waiting on player one.
					$('#player2-status-display').html("<p>Waiting on " + gameObj.playerOne + "</p>");
					$('#player1-status-display').html(otherPlayerWaiting);
				// Round tabulation is always done on user one's machine. This is to avoid duplicate database submission as well as unnecesarily tying up user computer power.
				} else if (gameObj.playerOneMove != "waiting" && gameObj.playerTwoMove != "waiting" && localPlayer === "One"){
					console.log("Fifth")
					// Both players have played.
					userOneMove = gameObj.playerOneMove;
					userTwoMove = gameObj.playerTwoMove;
		
					var roundResult = comparePlay();
					
					// This updates point values. Important that player move be updated before point values in order to avoid an infinity loop. 
					if (roundResult === "One wins"){
						console.log("One wins")
						$('win-status').text("Player One Wins!");
						gameObj.roundWinner = "One";
						playerOneLocalPoints++;
						firebase.database().ref('activeGames/' + gamePath).update({
								playerOneMove: "waiting",
								playerOnePoints: playerOneLocalPoints
						});

					} else if (roundResult === "Two wins"){
						console.log("Two wins")
						$('win-status').text("Player Two Wins!");
						gameObj.roundWinner = "Two";
						playerTwoLocalPoints++;
						firebase.database().ref('activeGames/' + gamePath).update({
								playerOneMove: "waiting",
								playerTwoPoints: playerTwoLocalPoints
						});

					} else if (roundResult === "Tie"){
						$('win-status').text("This rounds a tie.");
						gameObj.roundWinner = "Tie";

					};

				} else if (gameObj.playerOneMove != "waiting" && gameObj.playerTwoMove != "waiting" && localPlayer === "Two"){
					// Player two then recieves the results of the round
					var roundResult = comparePlay();

					if (roundResult === "One wins"){
						$('win-status').text("Player One Wins!");
					} else if (roundResult === "Two wins"){
						$('win-status').text("Player Two Wins!");
					} else if (roundResult === "Tie"){
						$('win-status').text("This rounds a tie.");
					};

					// Game waits 2 seconds to allow players to see results of the round
					// Database counters are then updated in preperation for the next round
					setTimeout(function() { 
						localRoundsRemaining--;
						firebase.database().ref('activeGames/' + gamePath).update({
								playerOneMove: "waiting",
								playerTwoMove: "waiting",
								roundWinner: roundResult,
								roundsRemaining: localRoundsRemaining
						});
						$('#win-status').text("");
					}, 2000);
				};

				// Updates displays
				$('#rounds-left-display').text(gameObj.roundsRemaining);
				$('#player1-wins-display').text(gameObj.playerOnePoints);
				$('#player2-wins-display').text(gameObj.playerTwoPoints);

				// This checks it see if the game is over. It is a seperate if statement because the game might have just ended.
				if (gameObj.roundsRemaining <= 0){
					
				};
				console.log("Full run gameplay detect function")

			}, function(error){
				console.log(error);
			}); 
		};

		function startGame(){
			console.log("Starting game")
			database.ref('activeGames').on("value", function(snapshot){
				gameObj = snapshot.val();
				console.log(gameObj);});
			// Clears out the previous parts of the game.
			displayUserList = false;
			$('#main-stage').remove();
			$('#message-console').remove();

			// This removes the player from the list of players looking for competitors. 
//			activeUserPath.remove();


			// This generates elements for the new game play.
			// Player display
			var player1Display = $('<div>').attr('id', 'player1-display');
			var player1Title = $('<h2>').attr('id', 'play1-title');
			var player1StatusDisplay = $('<div>').attr('id', 'player1-status-display');
			var player1WinsDisplay = $('<p>').html("Total wins: <span id='player1-wins-display'>0</span>");
			player1Display.append(player1Title);
			player1Display.append(player1StatusDisplay);
			player1Display.append(player1WinsDisplay);

			// Generates rounds lett message
			var roundsLeftDisplay = $('<h3>').attr('id', 'rounds-left-display');
			roundsLeftDisplay.html("Rounds remaining: <span id='rounds-left-display-span'>10</span><br><span id='win-status'></span>");

			// Player display
			var player2Display = $('<div>').attr('id', 'player2-display');
			var player2Title = $('<h2>').attr('id', 'play2-title');
			var player2StatusDisplay = $('<div>').attr('id', 'player2-status-display');
			var player2WinsDisplay = $('<p>').html("Total wins: <span id='player2-wins-display'>0</span>");
			player2Display.append(player2Title);
			player2Display.append(player2StatusDisplay);
			player2Display.append(player2WinsDisplay);

			var gameChatWindow = $('div').attr('id', 'game-chat-window');

			// Adds it all to the page
			$('body').append(player1Display);
			$('body').append(roundsLeftDisplay);
			$('body').append(player2Display);
			$('body').append(gameChatWindow);

			// The function for actual game play is then called. 
			console.log("About to start game play")
	/*		database.ref('activeGames').on("value", function(snapshot){
				gameObj = snapshot.val();
				console.log(gameObj);}); */
			gamePlay();
		};

		// Click functionality goes here
		$( document ).ready(function() {
			$("#set-name-button").on("click", function() {
				console.log("Set name button clicked")
				event.preventDefault();
				var userInput = $('#name-input').val();
				// Validates user input to make sure it's not blank and not a duplicate username.
				if (userInput.length === 0) {
					$('#error-display').text("Please enter a valid screen name.");
				} else if (activeUserList.indexOf(userInput) > -1){
					$('#error-display').text("Sorry, that name's already taken.");
				} else {
					addActiveUserData(userInput);
					moveOffPage("account-display");
					generateActiveUsersList();
					displayUserList = true;
				};

				// Click event for gameplay buttons
				$("body").on("click", "p.game-choice", function(){
					console.log("Game choice clicked")
					localMove = $(this).attr('type');
					// User selection is saved to a global variable which is then detected by the program else where in the code.

					console.log("Move detected");
					if (localPlayer === "One"){
							firebase.database().ref('activeGames/' + gamePath).update({
								playerOneMove: localMove
							});
							localMove = "none";
					} else if (localPlayer === "Two"){
							firebase.database().ref('activeGames/' + gamePath).update({
								playerTwoMove: localMove
							});
							localMove = "none";
					}; 
				});
				
			});

			$("body").on("click", "p.player-list-item", function(){
				console.log("Player list item clicked")
				var enemyTarget = $(this)[0].innerText;
				initChallenge(enemyTarget);
			});

		});

		Object.size = function(obj) {
			console.log("Checking object size")
		    var size = 0, key;
		    for (key in obj) {
		        if (obj.hasOwnProperty(key)) size++;
		    }
		    return size;
		};

		// This interacts with the database and maintains a list of active users.
		database.ref('activeUsers/').on("value", function(snapshot){
			console.log("Active users database has updated")
/*
			// For reference
				database.ref('activeGames').on("value", function(snapshot){
					gameObjT = snapshot.val();
					console.log(gameObjT);});
*/
			var activeUsersObj = snapshot.val();
			currentUserCount = Object.size(activeUsersObj);
			activeUserList = [];
			for (var key in activeUsersObj) {
			  if (activeUsersObj.hasOwnProperty(key)) {
			  	// This inner if statement ensures the program doesn't display users who are already actively involved in a challenge. 
	//		    if (inGamePlay.indexOf(key) < 0){
			    	activeUserList.push(key);
	//		    };
			  }
			}

			// If the current user list is currently being displayed, it will be updated.
			if (displayUserList){
				generateActiveUsersList();
			}
		}, function(error){
			console.log(error);
			console.log("Error run")
		});

		// This keeps tabs on open challenges
		database.ref('activeUChallenges/').on("value", function(snapshot){
			console.log("Active U Challenges database has updated")
			var activeChallengesObj = snapshot.val();
			for (var key in activeChallengesObj) {
			    if (activeChallengesObj.hasOwnProperty(key)) {
				    var localChallenger = key.split("-")[0];
				    var localTarget = key.split("-")[1];
				    var localPath = activeChallengesObj[localChallenger + "-" + localTarget];
				    var localStatus = localPath.ChallengeStatus;

				    // This removes open challengs if one or both of the users has left the site.
				    // Next the function checks to see if the current user is being challenged. 
				    // The next part checks for responses to open challenges from current user.
				    if (activeUserList.indexOf(localChallenger) < 0 || activeUserList.indexOf(localTarget) < 0){
				    	database.ref('activeUChallenges/' + key).remove();
				    } else if (localTarget === currentUser && localStatus === "is_open"){
				    	// Current user is being challenged! 
				    	var challengeMessage = $('<p>').attr("class", "message game-message");
				    	challengeMessage.text("You've been challenged by " + localChallenger + "!");
				    	var acceptButton = $('<button>').attr('class', 'chat-button accept-button');
				    	acceptButton.attr('value', localChallenger);
				    	acceptButton.text("Accept");
				    	var declineButton = $('<button>').attr('class', 'chat-button decline-button');
				    	declineButton.attr('value', localChallenger);
				    	declineButton.text("Decline");
				    	challengeMessage.append(acceptButton);
				    	challengeMessage.append(declineButton);
				    	$('#message-console').append(challengeMessage);

				    	// This is what happens when a player accepts a challenge.
						$("body").on("click", "button.accept-button", function(){
							gameChallenger = this.value;

							// The database is updated
							firebase.database().ref('activeUChallenges/' + key).update({
								ChallengeStatus: "accepted"
							});

							// This sets the key that will be used to access game play info.
							gamePath = currentUser + "-" + gameChallenger;

							// This sets up the object that will manage game play info.
							console.log("About to set new game node")
							firebase.database().ref('activeGames/' + gamePath).set({
								playerOne: currentUser,
								playerTwo: gameChallenger,
								playerOneMove: "waiting",
								playerTwoMove: "waiting",
								roundWinner: "none",
								playerOnePoints: 0,
								playerTwoPoints: 0,
								roundsRemaining: 10
							});

							startGame();
						});

						// This is what happens when a player declines a challenge.
						$("body").on("click", "button.decline-button", function(){
							// The database is updated
							firebase.database().ref('activeUChallenges/' + key).update({
								ChallengeStatus: "declined"
							});
							printMessage("Game", "You have declined the challenge.");
						});

				    	// This updates the status of the challenge so it is not re-posted.
						firebase.database().ref('activeUChallenges/' + key).update({
							ChallengeStatus: "recieved"
						});
				    } else if (localChallenger === currentUser){
						if (localStatus === "accepted"){
							printMessage("Game", localTarget + " has accepted your challenge!");
							gameChallenger = localTarget;

							// This sets the key that will be used to access game play info.
							gamePath = gameChallenger + "-" + currentUser;

							setTimeout(function() { 
								startGame();
							}, 2000);
						} else if (localStatus === "declined"){
							printMessage("Game", localTarget + " has declined your challenge.");

							firebase.database().ref('activeUChallenges/' + key).update({
								ChallengeStatus: "ended"
							});
						};  	
				    };
			    };
			};
		}, function(error){
			console.log(error);
			console.log("Error run")
		});

		// This goes through and deletes challenges that are not being actively used. IE-- If one or both players are now offiline. 
		// EDIT: This causes problems since it is based on whether or not users are currently active but users are removed from the active list when they enter game play causing the game obj to be deleted. 
		// A work around is possible by maintaining a seperate list of users actively playing games and using detecting when they disconnect. 
		// In the short term, however, I have decided to leave game objs in the database so that I can see who's playing and how the game is going. 
		// This could also eventually be used to develop some sort of high score list based on wins in a row. 
		/*
		database.ref('activeGames/').on("value", function(snapshot){
			var activeGamesObj = snapshot.val();
			for (var key in activeGamesObj) {
				var localFirst = key.split("-")[0];
				var localSecond = key.split("-")[1];
				if (activeUserList.indexOf(localFirst) < 0 || activeUserList.indexOf(localSecond) < 0){
				    database.ref('activeGames/' + key).remove();
				};
			};
		}, function(error){
			console.log(error);
		});
		*/

		/* To check OBJ contents: 
		database.ref('activeGames').on("value", function(snapshot){
				gameObj = snapshot.val();
				console.log(gameObj);});
		*/

	</script>
</body>
</html>